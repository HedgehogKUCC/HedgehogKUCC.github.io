---
title: Gulp
date: 2019-11-16
tags: gulp
---

# Gulp - Quick Start

## 安裝環境

1. [Node.js](https://nodejs.org/en/)

2. gulp-cli

```bash
$ sudo npm install gulp-cli -g
```

<br>

## 環境建置

### 產生出一個 `package.json`

```bash
$ npm init
```

### 安裝 `gulp 4.x.x`

```bash
npm install --sava-dev gulp
```

### 新增 `gulpfile.js`

新增資料夾 `source` 裡面在新增 `index.html`

<br>

## 範例： 使用 task 複製文件至指定資料夾下

`gulpfile.js`

```js
var gulp = require('gulp');

gulp.task('copyHTML', function () {
  return gulp.src('./source/**/*.html')
    .pipe(gulp.dest('./public/'))
})
```

出現 `ReferenceError: primordials is not defined` [連結](https://stackoverflow.com/questions/55921442/how-to-fix-referenceerror-primordials-is-not-defined-in-node)

原因是 `node v12.x.x` 和 `gulp v3.9.x`

解決方法 (二擇一)

1. node 降至 v11
2. gulp 升至 v4

本來使用 ***方法1*** 是由於課程使用 `gulp 3.9.1`

但是發現 `解除安裝 Node` 太過麻煩

所以改用 ***方法2***

```bash
$ gulp copyHTML
```

會看到 source 資料夾下的 index.html 

複製出一份到 public 資料夾下

<br>

# gulp-jade

[npm-jade](https://www.npmjs.com/package/gulp-jade)

## 安裝

```bash
$ npm install --save gulp-jade
```

<br>

## Quick Start

1. 將 `source` 的 `index.html` 刪除，新建 `index.jade`
2. 將 `public` 資料夾刪除

### gulpfile.js

```js
var jade = require('gulp-jade');

gulp.task('jade', function() {
  // var YOUR_LOCALS = {};
 
  return gulp.src('./source/**/*.jade')
    .pipe(jade({
      // locals: YOUR_LOCALS
      pretty: true
    }))
    .pipe(gulp.dest('./public/'))
});
```

因為 `gulp v4` 的關係請在 `gulp.src` 前面加上 `return`

不然會跳出以下訊息

- The following tasks did not complete: jade
- Did you forget to signal async completion?

```bash
$ gulp jade
```

就會成功將 `.jade` 編譯成 `.html`

`pretty: true` : 會將 `.html` 內容展開

沒有加上 `pretty: true` 就會是 ***壓縮過後*** 的 `.html`

<br>

# gulp-sass

[npm-sass](https://www.npmjs.com/package/gulp-sass)

## 安裝

```bash
$ npm install --save gulp-sass
```

<br>

## Quick Start

`source` 資料夾下 新增 `scss` 資料夾 裡面再 新增 `all.scss`

`all.scss`

```scss
$primary-color: red;

body {
  color: $primary-color;
}
```

<br>

`gulpfile.js`

```js
var sass = require('gulp-sass');

gulp.task('sass', function () {
  return gulp.src('./source/scss/**/*.scss')
    .pipe(sass().on('error', sass.logError))
    .pipe(gulp.dest('./public/css/'));
});
```

<br>

```bash
$ gulp sass
```

看有沒有將 `.scss` 編譯出 `.css`

<br>

## gulp.watch & gulp.series & gulp.parallel

`gulpfile.js`

```js
gulp.task('watch', function () {
  gulp.watch('./source/scss/**/*.scss', ['sass'] );
});
```

使用上面這段程式碼會出現錯誤 [連結](https://stackoverflow.com/questions/39665773/gulp-error-watch-task-has-to-be-a-function)

`Error: watching ./source/scss/**/*.scss: watch task has to be a function (optionally generated by using gulp.parallel or gulp.series)`

這是因為 `gulp v4` 增加了 `gulp.parallel` 和 `gulp.series` 兩個方法

修改成下方

```js
gulp.task('watch', function () {
  gulp.watch('./source/scss/**/*.scss', gulp.series('sass'));
});
```

在執行

```bash
$ gulp watch
```

嘗試將 `all.scss` 裡面的 `red` 改成 `blue` 看有沒有編譯成功出在 `all.css`

會是這樣呈現如下

```
$ gulp watch
[11:44:50] Using gulpfile ~/Desktop/DemoGulp/gulpfile.js
[11:44:50] Starting 'watch'...
[11:44:59] Starting 'sass'...
[11:44:59] Finished 'sass' after 24 ms
```

<br>

`gulp.parallel` : 同時執行

`gulp.series` : 依序執行

**這兩個方法可以一起搭配使用 !!!**

<br>

## 整合 jade sass watch

`gulpfile.js`

```js
gulp.task('watch', function () {
  gulp.watch('./source/scss/**/*.scss', gulp.series('sass'));
  gulp.watch('./source/**/*.jade', gulp.series('jade'));
});

gulp.task('default', 
  gulp.parallel('jade', 'sass', 'watch')
);
```

<br>

在 `terminal` 直接輸入 `gulp` Enter 

```bash
$ gulp
```

就會開始同時執行 `gulp.task 'default'` 裡面的其它任務

<br>

## gulp-plumber

[npm-plumber](https://www.npmjs.com/package/gulp-plumber)

避免在監控 (watch) 時，因為出現錯誤而停止了整個監控 !

但是在 `gulp v4`，我現在還沒加上就已經有這個功能了。

現階段還是照著教學加上去

### 安裝

```bash
$ npm install --save gulp-plumber
```

<br>

在 `gulp.src` 後面都加上 `.pipe(plumber())`

```js
gulp.task('jade', function() {
 
  return gulp.src('./source/**/*.jade')
    .pipe(plumber())
    .pipe(jade({
      pretty: true
    }))
    .pipe(gulp.dest('./public/'))
});

gulp.task('sass', function () {
  return gulp.src('./source/scss/**/*.scss')
    .pipe(plumber())
    .pipe(sass().on('error', sass.logError))
    .pipe(gulp.dest('./public/css/'));
});
```

<br>

# 更高明的 CSS 優化流程

## gulp-postcss & autoprefixer

[npm-postcss](https://www.npmjs.com/package/gulp-postcss)

[npm-autoprefixer](https://www.npmjs.com/package/autoprefixer)

[Browserslist](https://github.com/browserslist/browserslist)

```bash
$ npm install --save gulp-postcss autoprefixer
```

### 配置

`all.scss`

```scss
.card {
  transform: rotate(120deg);
  filter: blur(3px);
}
```

<br>

`gulpfile.js`

```js
var postcss = require('gulp-postcss');
var autoprefixer = require('autoprefixer');

gulp.task('sass', function () {

  var plugins = [
    autoprefixer({ browsers: ['last 3 version', '> 5%', 'ie 6-8'] })
  ];

  return gulp.src('./source/scss/**/*.scss')
    .pipe(plumber())
    .pipe(sass().on('error', sass.logError))
    // 編譯完成 CSS

    .pipe(postcss(plugins))
    .pipe(gulp.dest('./public/css/'));
});
```

<br>

執行時會出現以下錯誤

	Replace Autoprefixer browsers option to Browserslist config.

    Use browserslist key in package.json or .browserslistrc file.

    Using browsers option cause some error. Browserslist config 

    can be used for Babel, Autoprefixer, postcss-normalize and other tools.

    ----------------------------------------------------------------------------
    *                                                                          *
    *   If you really need to use option, rename it to overrideBrowserslist.   *
    *                                                                          *
    ----------------------------------------------------------------------------

	  Learn more at:

        https://github.com/browserslist/browserslist#readme

        https://twitter.com/browserslist

<br>

將 `browsers` 修改為 `overrideBrowserslist` 就可以囉

<br>

執行 `$ gulp` 會發現 `all.css` 有加上前綴詞

```css
.card {
  -webkit-transform: rotate(120deg);
      -ms-transform: rotate(120deg);
          transform: rotate(120deg);
  -webkit-filter: blur(3px);
          filter: blur(3px); }
```

<br>

### 官方建議配置

`package.json`

```json
"browserslist": [
    "last 3 version",
    "> 5%",
    "IE 10"
  ]
```

<br>

`gulpfile.js`

```js
gulp.task('sass', function () {

  // var plugins = [
  //   autoprefixer({ overrideBrowserslist: [ 'last 3 version', '> 5%', 'ie 6-8' ] })
  // ];

  return gulp.src('./source/scss/**/*.scss')
    .pipe(plumber())
    .pipe(sass().on('error', sass.logError))
    // 編譯完成 CSS

    // .pipe(postcss(plugins))
    .pipe(postcss( [autoprefixer()] ))  // 直接引入 autoprefixer
    
    .pipe(gulp.dest('./public/css/'));
});
```

<br>

# gulp-load-plugins

[npm-gulp-load-plugins](https://www.npmjs.com/package/gulp-load-plugins)

## 安裝

```bash
$ npm install --save gulp-load-plugins
```

### 配置

`gulpfile.js`

```js
var $ = require('gulp-load-plugins')();
```

刪除

```js
var jade = require('gulp-jade');
var sass = require('gulp-sass');
var plumber = require('gulp-plumber');
var postcss = require('gulp-postcss');
```

<br>

將有使用到的套件前面加上 `$.`

```js
gulp.task('jade', function() {
 
  return gulp.src('./source/**/*.jade')
    .pipe($.plumber())
    .pipe($.jade({
      pretty: true
    }))
    .pipe(gulp.dest('./public/'))
});

gulp.task('sass', function () {
  return gulp.src('./source/scss/**/*.scss')
    .pipe($.plumber())
    .pipe($.sass().on('error', $.sass.logError))
    .pipe($.postcss( [autoprefixer()] ))
    .pipe(gulp.dest('./public/css/'));
});
```

記得在 `$ gulp` 測試看看有無錯誤

<br>

# gulp-babel

[npm-babel](https://www.npmjs.com/package/gulp-babel)

## 安裝

```bash
$ npm install --save gulp-babel @babel/core @babel/preset-env
$ npm install --save gulp-concat gulp-sourcemaps
```

<br>

### 配置

`source` 資料夾下 新增 `all.js` `all2.js`

all.js

```js
let newFun = () => {
  console.log('a');
}

newFun();
```

all2.js

```js
let newFun2 = () => {
  console.log('b');
}

newFun2();
```

<br>

`gulpfile.js`

```js
gulp.task('babel', () => {
  return gulp.src('./source/js/**/*.js')
    .pipe($.babel({
      presets: ['@babel/env']
    }))
    .pipe(gulp.dest('./public/js/'))
});

gulp.task('watch', function () {
  gulp.watch('./source/scss/**/*.scss', gulp.series('sass'));
  gulp.watch('./source/**/*.jade', gulp.series('jade'));
  gulp.watch('./source/**/*.js', gulp.series('babel'));
});

gulp.task('default', 
  gulp.parallel('jade', 'sass', 'babel', 'watch')
);
```

<br>

### gulp-concat

會將 `source > js` 裡面的兩隻 `.js` 合併為一個 

`gulpfile.js`

```js
gulp.task('babel', () => {
  return gulp.src('./source/js/**/*.js')
    .pipe($.babel({
      presets: ['@babel/env']
    }))
    .pipe($.concat('all.js'))
    .pipe(gulp.dest('./public/js/'))
});
```

<br>

### gulp-sourcemaps

會將內容正確顯示出沒有合併前的檔案位置

`gulpfile.js`

```js
gulp.task('babel', () => {
  return gulp.src('./source/js/**/*.js')
    .pipe($.sourcemaps.init())
    .pipe($.babel({
      presets: ['@babel/env']
    }))
    .pipe($.concat('all.js'))
    .pipe($.sourcemaps.write('.'))
    .pipe(gulp.dest('./public/js/'))
});
```

